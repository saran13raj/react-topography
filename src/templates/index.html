<!doctype html>
<html>
  <head>
    <title>Component Mindmap (Drawflow)</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css"
    />
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      #mindmap-container {
        width: 100vw;
        height: 100vh;
        background: #f9fafb;
        position: relative;
      }
      .drawflow .drawflow-node {
        background: #fff;
        border: 2px solid #333;
        border-radius: 8px;
        width: fit-content;
        height: 0.2rem;
        min-height: 0.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: sans-serif;
        font-size: 16px;
        color: #222;
      }
      .drawflow .drawflow-node .input {
        left: -23px;
        background: #56dfcf;
      }
      .drawflow .drawflow-node .output {
        right: -9px;
      }
      .drawflow .drawflow-node .inputs .input_1,
      .drawflow .drawflow-node .outputs .output_1 {
        height: 10px;
        width: 10px;
      }
      .drawflow .drawflow-node.selected {
        background: #ffedf3;
      }
      .drawflow .connection .main-path {
        stroke: #888;
        stroke-width: 2;
      }
      .drawflow .connection .point {
        fill: #888;
      }
    </style>
  </head>
  <body>
    <div id="mindmap-container"></div>
    <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
    <script>
      // Layout constants
      const NODE_WIDTH = 140;
      const NODE_HEIGHT = 40;
      const X_GAP = 100;
      const Y_GAP = 40;

      // Initialize Drawflow
      const container = document.getElementById("mindmap-container");
      const editor = new Drawflow(container);
      editor.reroute = true;
      editor.start();

      // Set zoom limits
      editor.zoom_max = 2.0;
      editor.zoom_min = 0.5;

      editor.editor_mode = "fixed"; // Only scroll

      // Recursive layout and node creation
      function layoutTree(node, x, y, nodes = [], edges = [], parentId = null) {
        const nodeId = nodes.length;
        nodes.push({
          id: nodeId,
          name: node.name,
          x,
          y,
        });
        if (parentId !== null) {
          edges.push({
            from: parentId,
            to: nodeId,
          });
        }
        let childY = y;
        node.children.forEach((child) => {
          layoutTree(
            child,
            x + NODE_WIDTH + X_GAP,
            childY,
            nodes,
            edges,
            nodeId,
          );
          childY += NODE_HEIGHT + Y_GAP;
        });
        return { nodes, edges };
      }

      function renderMindmap(data) {
        editor.clearModuleSelected();
        const { nodes, edges } = layoutTree(data, 40, 40);

        // Add nodes to Drawflow
        nodes.forEach((node) => {
          editor.addNode(
            node.id,
            1, // inputs
            1, // outputs
            node.x,
            node.y,
            "",
            { name: node.name },
            `<div>${node.name}</div>`,
          );
        });

        // Add connections
        edges.forEach((edge) => {
          editor.addConnection(
            edge.from + 1,
            edge.to + 1,
            "output_1",
            "input_1",
          );
        });
      }

      // Fetch and render mindmap
      fetch("/mindmap.json")
        .then((res) => res.json())
        .then((data) => {
          renderMindmap(data);
        });
    </script>
  </body>
</html>
